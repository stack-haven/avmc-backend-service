# Go-Kratos 大仓模式微服务项目规范

## 1. 项目结构规范

### 1.1 目录结构

```
├── .docker                     # Docker相关配置
│   ├── Dockerfile             # 主Dockerfile
│   └── compose                # Docker Compose配置
├── api                        # API定义目录
│   ├── admin                  # 管理后台API
│   │   ├── interface         # 接口定义
│   │   └── service          # 服务定义
│   └── common                # 公共API定义
├── app                        # 应用目录（多个微服务）
│   ├── admin                 # 管理后台服务
│   │   ├── cmd              # 启动入口
│   │   ├── configs         # 配置文件
│   │   └── internal        # 内部代码
│   └── other_service        # 其他微服务
├── pkg                        # 共享库目录
│   ├── errors               # 错误处理库
│   └── middleware           # 中间件库
├── proto                      # Proto文件目录
│   ├── admin                 # 管理后台Proto
│   ├── common                # 公共Proto
│   └── third_party          # 第三方Proto
└── tests                     # 测试目录
```

### 1.2 共享库管理
- pkg 目录用于存放多个服务共享的代码
- 共享库必须有明确的职责划分
- 避免服务间直接依赖，通过共享库解耦
- 共享库必须有完整的单元测试和文档

### 1.3 服务模块划分
- 每个微服务必须遵循 DDD (Domain-Driven Design) 分层架构：
  - `internal/service`: 服务层，处理 RPC 请求
  - `internal/biz`: 业务逻辑层
  - `internal/data`: 数据访问层
  - `internal/server`: HTTP/gRPC 服务器

### 1.4 服务拆分原则
- 按业务领域划分服务边界
- 服务粒度适中，避免过大或过小
- 服务间通过 gRPC 或消息队列通信
- 每个服务独立部署和扩展
- 服务间避免循环依赖

### 1.5 微服务治理
- 服务注册与发现
  - 使用 etcd/consul 作为注册中心
  - 服务健康检查机制
  - 负载均衡策略配置
- 配置中心
  - 统一配置管理
  - 配置热更新机制
  - 多环境配置隔离
- 链路追踪
  - 使用 OpenTelemetry 标准
  - 采样率配置
  - 链路上下文传递

## 2. 开发规范

### 2.1 Proto 文件规范
- 所有 API 定义必须使用 Protocol Buffers
- 文件命名：
  - `i_*.proto` 表示接口定义
  - `s_*.proto` 表示服务定义
  - `m_*.proto` 表示模型定义
- 必须包含完整的注释说明
- 使用 buf 工具管理 proto 生态

### 2.2 错误处理规范
- 统一使用 Kratos 错误码机制
- 错误码格式：服务.模块.具体错误
- 必须在 proto 中定义错误码

### 2.3 配置管理
- 使用 proto 定义配置结构
- 配置分环境存放在 configs 目录
- 敏感配置必须使用环境变量注入

### 2.4 日志规范
- 统一使用 Kratos 的 log 接口
- 必须包含关键字段：
  - trace_id: 追踪标识
  - span_id: 跨度标识
  - service.name: 服务名称
  - service.version: 服务版本

### 2.5 中间件规范
- 统一注册中间件：
  - Recovery: 服务恢复
  - Tracing: 链路追踪
  - Logging: 访问日志
  - Metrics: 监控指标
  - Validation: 参数校验

## 3. 编码规范

### 3.1 命名规范
- 包名：全小写，简短有意义
- 接口名：大驼峰，动词+名词
- 错误变量：以 `Err` 开头
- 常量：全大写下划线分隔

### 3.2 接口设计
- RESTful API 规范：
  - GET：查询
  - POST：创建
  - PUT：更新
  - DELETE：删除
- 版本控制：URL 中包含版本号 `/v1/`

### 3.3 数据库规范
- 表名：小写下划线分隔
- 主键：统一使用 `id`
- 必备字段：
  - created_at
  - updated_at
  - deleted_at（软删除）

### 3.4 测试规范
- 单元测试：必须覆盖核心业务逻辑
- 基准测试：关键性能点必须有基准测试
- 集成测试：HTTP/gRPC 接口必须有测试用例

## 4. 部署规范

### 4.1 容器化
- 使用多阶段构建
- 基础镜像统一使用 Alpine
- 暴露健康检查接口

### 4.2 配置中心
- 区分环境配置
- 支持配置热更新
- 敏感信息使用加密存储

### 4.3 服务注册
- 服务注册与发现
- 健康检查
- 负载均衡策略

## 5. 监控规范

### 5.1 监控指标
- 基础指标：CPU、内存、磁盘
- 服务指标：QPS、延迟、错误率
- 业务指标：自定义关键指标

### 5.2 告警规则
- 设置合理的告警阈值
- 告警级别分类
- 告警通知渠道

## 6. 文档规范

### 6.1 接口文档
- 使用 OpenAPI 规范
- 详细的接口说明
- 请求/响应示例

### 6.2 架构文档
- 系统架构图
- 数据流图
- 部署架构图

## 7. CI/CD与版本发布

### 7.1 版本号规范
- 遵循 Semantic Versioning
- 格式：主版本号.次版本号.修订号
- 所有服务统一版本发布

### 7.2 CI/CD流程
- 代码提交规范
  - 使用 Conventional Commits
  - 分支管理策略
  - 代码审查流程
- 持续集成
  - 自动化测试
  - 代码质量检查
  - 构建产物管理
- 持续部署
  - 环境管理
  - 部署策略
  - 回滚机制

### 7.3 发布流程
- 发布准备
  - 版本变更日志
  - 数据库变更脚本
  - 配置更新检查
- 发布步骤
  - 预发布验证
  - 灰度发布
  - 全量发布
- 发布后验证
  - 服务健康检查
  - 监控指标验证
  - 业务功能验证

## 8. 文档规范

### 8.1 架构文档
- 系统架构图
  - 整体架构图
  - 服务依赖图
  - 数据流图
- 技术选型文档
  - 组件选择理由
  - 性能评估报告
- 部署架构文档
  - 环境说明
  - 扩展方案
  - 容灾方案

### 8.2 开发文档
- 开发环境搭建
- 编码规范说明
- 调试和测试指南
- 常见问题解决

### 8.3 API文档
- OpenAPI/Swagger规范
- 接口变更记录
- 错误码说明
- 示例代码

### 8.4 运维文档
- 部署操作手册
- 监控告警说明
- 日志规范
- 应急处理流程
